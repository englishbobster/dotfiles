#!/bin/bash

TARGET_WS_ADDR="http://tnm-load-reg:8080"
#TARGET_WS_ADDR="http://localhost:8080"
ENTRY_POINT="/soap/mtosi/layered/ResourceInventoryRetrieval"

RESPONSE=`curl --header "Content-Type: text/xml;charset=UTF-8" --header "SOAPAction: getInventory" --data @get_resource_inv_req.xml "$TARGET_WS_ADDR$ENTRY_POINT" --connect-timeout 10 &`

REF=`xmlstarlet sel -N ns7="http://www.tmforum.org/mtop/fmw/xsd/hdr/v1" -t -m "//ns7:iteratorReferenceURI" -v . <(echo $RESPONSE)`
END=`xmlstarlet sel -N ns7="http://www.tmforum.org/mtop/fmw/xsd/hdr/v1" -t -m "//ns7:batchSequenceEndOfReply" -v . <(echo $RESPONSE)`

xmlstarlet ed -O -u "//v1:iteratorReferenceURI" -v $REF get_resource_inv_iterator_req.xml > tmp.xml

while [ "$END" != "true" ]; do
    RESPONSE=`curl --header "Content-Type: text/xml;charset=UTF-8" --header "SOAPAction: getInventoryIterator" --data @tmp.xml "$TARGET_WS_ADDR$ENTRY_POINT" --connect-timeout 10 &`
#    echo $RESPONSE
#    REF=`xmlstarlet sel -N ns7="http://www.tmforum.org/mtop/fmw/xsd/hdr/v1" -t -m "//ns7:iteratorReferenceURI" -v . <(echo $RESPONSE)`
    END=`xmlstarlet sel -N ns7="http://www.tmforum.org/mtop/fmw/xsd/hdr/v1" -t -m "//ns7:batchSequenceEndOfReply" -v . <(echo $RESPONSE)`

    echo "***$END****"
done

