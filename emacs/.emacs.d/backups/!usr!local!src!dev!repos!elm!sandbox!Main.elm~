module Main (..) where

import Html
import Time
import Http
import Task exposing (andThen)
import Json.Decode exposing (list, string)
import Graphics.Element exposing (Element, show)

view : List String -> Element
view message =
   show message


clockSignal : Signal Time.Time
clockSignal =
  Time.every (2 * Time.second)


mb : Signal.Mailbox (List String)
mb =
  Signal.mailbox []


httpTask : Task.Task Http.RawError Http.Response
httpTask =
  Http.send Http.defaultSettings alarmsGet


loginTask : Task.Task Http.RawError Http.Response
loginTask =
  Http.send Http.defaultSettings loginPost


sendToMb : List String -> Task.Task x ()
sendToMb result =
  Signal.send mb.address result


responseToTask: Task.Task Http.Error (List String)
responseToTask =
  Http.fromJson (list string) httpTask


runTask : Task.Task Http.Error ()
runTask =
  responseToTask `andThen` sendToMb


taskSignal : Signal (Task.Task Http.Error ())
taskSignal =
  Signal.map (always runTask) clockSignal


main : Signal.Signal  Element
main =
  Signal.map view mb.signal


port runner : Signal (Task.Task Http.Error ())
port runner =
  taskSignal


alarmsGet : Http.Request
alarmsGet =
  { verb = "GET"
  , headers =
      [
       ("Content-Type", "application/x-www-form-urlencoded")
      ]
  , url = "http://localhost:8081/api/alarm/ethernet/"
  , body = Http.empty
  }

loginPost : Http.Request
loginPost =
  { verb = "POST"
  , headers =
      [
       ("Content-Type", "application/x-www-form-urlencoded")
      ]
  , url = "http://localhost:8081/login?username=admin&password=admin"
  , body = Http.empty
  }
